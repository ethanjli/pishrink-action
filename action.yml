name: "Run PiShrink"
author: ethanjli
description: Shrinks and compresses a Raspberry Pi SD card image.
branding:
  icon: minimize-2
  color: red

inputs:
  image:
    description: Path of the image to shrink
    required: true
  destination:
    description: Path to write the shrunken image to
    required: false
  compress:
    description:
      Compress the image after shrinking using gzip or xz;
      if set, the `.gz` or `.xz` extension (respectively) will be added to the file name.
      Allowed values are `gzip`, `xz`, and `none`.
    required: false
    default: none
  compress-parallel:
    description:
      Compress the image in parallel using multiple cores;
      use option `-f9` for pigz and option `-T0` for xz and compress in parallel
    required: false
    default: false
  prevent-expansion:
    description: Prevent automatic filesystem expansion when the image is booted for the first time
    required: false
    default: false
  advanced-fs-repair:
    description: Attempt to repair the filesystem using additional options if the normal repair fails
    required: false
    default: false
  verbose:
    description: Enable more verbose output
    required: false
    default: false
  # TODO: expose the -d flag - but where does the debug log file get written, and how should we
  # expose it?

outputs:
  destination:
    description: Path of the shrunken image
    value: ${{ steps.run-pishrink.outputs.destination }}

runs:
  using: composite
  steps:
    - id: run-pishrink
      shell: bash
      env:
        INPUT_IMAGE: ${{ inputs.image }}
        INPUT_DESTINATION: ${{ inputs.destination }}
        INPUT_COMPRESS: ${{ inputs.compress }}
        INPUT_COMPRESS_PARALLEL: ${{ inputs.compress-parallel }}
        INPUT_PREVENT_EXPANSION: ${{ inputs.prevent-expansion }}
        INPUT_ADVANCED_FS_REPAIR: ${{ inputs.advanced-fs-repair }}
        INPUT_VERBOSE: ${{ inputs.verbose }}
      run: |
        flags=""
        destination=""
        case "$INPUT_COMPRESS" in
          gzip | gz)
            flags="$flags -z"
            if [ ! -z "$INPUT_DESTINATION" ]; then
              destination="$(echo "$INPUT_DESTINATION" | sed -e 's~\.gz$~~')"
              echo "destination=$destination.gz" >> $GITHUB_OUTPUT
            else
              echo "destination=$INPUT_IMAGE.gz" >> $GITHUB_OUTPUT
            fi
            ;;
          xz)
            flags="$flags -Z"
            if [ ! -z "$INPUT_DESTINATION" ]; then
              destination="$(echo "$INPUT_DESTINATION" | sed -e 's~\.xz$~~')"
              echo "destination=$destination.xz" >> $GITHUB_OUTPUT
            else
              echo "destination=$INPUT_IMAGE.xz" >> $GITHUB_OUTPUT
            fi
            ;;
          none | "false" | "")
            echo "destination=$INPUT_DESTINATION" >> $GITHUB_OUTPUT
            ;;
          *)
            echo "Error: unrecognized compression type: $INPUT_COMPRESS"
            exit 1
            ;;
        esac
        if [ "$INPUT_COMPRESS_PARALLEL" == "true" ]; then
          flags="$flags -a"
        fi
        if [ "$INPUT_PREVENT_EXPANSION" == "true" ]; then
          flags="$flags -s"
        fi
        if [ "$INPUT_ADVANCED_FS_REPAIR" == "true" ]; then
          flags="$flags -r"
        fi
        if [ "$INPUT_VERBOSE" == "true" ]; then
          flags="$flags -v"
        fi

        echo "Running pishrink.sh $flags \"$INPUT_IMAGE\" \"$destination\"..."
        sudo ${{ github.action_path }}/pishrink.sh $flags "$INPUT_IMAGE" "$destination"
